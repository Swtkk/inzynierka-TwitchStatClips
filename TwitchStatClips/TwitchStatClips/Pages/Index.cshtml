@page
@model IndexModel
@{
    ViewData["Title"] = "Twitch Clips";

    var selectedPeriod = Request.Query["period"].ToString();
    if (string.IsNullOrEmpty(selectedPeriod))
    {
        selectedPeriod = "week";
    }

    var periodOptions = new Dictionary<string, string>
    {
        { "day", "24h" },
        { "week", "7 dni" },
        { "month", "30 dni" },
        { "all", "Ogólne" }
    };
}

<h1 class="mb-4">Klipy z gry <span id="gameName">@Model.SelectedGame</span></h1>
<div id="loader" class="text-center my-5">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Ładowanie...</span>
    </div>
</div>

<!-- Nowe przyciski okresu -->
<div class="mb-4">
    <div class="btn-group" role="group" aria-label="Wybierz okres">
        @foreach (var option in periodOptions)
        {
            var isActive = selectedPeriod == option.Key;
            <a class="btn @(isActive ? "btn-primary" : "btn-outline-primary")"
               asp-page="/Index"
               asp-route-gameName="@Model.SelectedGame"
               asp-route-period="@option.Key">
                @option.Value
            </a>
        }
    </div>
</div>

<!-- Klipy -->
<div class="row" id="clips-container"></div>

<!-- Przycisk "Załaduj więcej" -->
<div class="text-center mt-4 mb-5">
    <button id="loadMoreBtn" class="btn btn-primary">Załaduj więcej</button>
</div>

<!-- Modal -->
<div id="clipModal" class="modal-overlay" style="display:none;" onclick="hideClipModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <iframe id="modalIframe" src="" allowfullscreen loading="lazy" frameborder="0"></iframe>
    </div>
</div>



@section Scripts {
    <script>
        const gameName = "@Model.SelectedGame";
        const period = "@selectedPeriod";
        const clipsPerPage = 8;
        let allClips = [];
        let visibleClips = 0;

        function showClipModal(embedUrl) {
            const modal = document.getElementById("clipModal");
            const iframe = document.getElementById("modalIframe");
            iframe.src = `${embedUrl}&parent=${location.hostname}`;
            modal.style.display = "flex";
        }

        function hideClipModal(event) {
            const modal = document.getElementById("clipModal");
            const iframe = document.getElementById("modalIframe");
            iframe.src = "";
            modal.style.display = "none";
        }

                async function loadAllClipsOnce() {
            const loader = document.getElementById("loader");
            loader.style.display = "block";

            const response = await fetch(`/api/clips?gameName=${encodeURIComponent(gameName)}&period=${period}`);
            const data = await response.json();
            allClips = data.clips;
            visibleClips = 0;

            document.getElementById("clips-container").innerHTML = "";
            loader.style.display = "none";
            renderMoreClips();
        }


        function renderMoreClips() {
            const container = document.getElementById("clips-container");
            const btn = document.getElementById("loadMoreBtn");

            const nextClips = allClips.slice(visibleClips, visibleClips + clipsPerPage);
            visibleClips += nextClips.length;

            nextClips.forEach(clip => {
                const col = document.createElement("div");
                col.className = "col-md-3 mb-4";

                col.innerHTML = `
                    <div class="card h-100 shadow-sm">
                        <div class="clip-container" style="cursor:pointer;" onclick="showClipModal('${clip.embedUrl}')">
                            <img src="${clip.thumbnailUrl}" alt="${clip.title}" class="card-img-top" style="width:100%; height:auto;" />
                        </div>
                        <div class="card-body">
                            <h6 class="card-title mb-2">${clip.title}</h6>
                            <p class="card-text text-muted mb-0">Autor: ${clip.broadcasterName}</p>
                        </div>
                    </div>`;
                container.appendChild(col);
            });

            if (visibleClips >= allClips.length) {
                btn.style.display = "none";
            }
        }

        document.getElementById("loadMoreBtn").addEventListener("click", renderMoreClips);
        window.addEventListener("DOMContentLoaded", loadAllClipsOnce);
    </script>
}
