@page
@model IndexModel
@{
    ViewData["Title"] = "Twitch Clips";
}

<h1>Klipy z gry <span id="gameName">@Model.SelectedGame</span></h1>

<!-- Filtrowanie -->
<div class="mb-3">
    <label for="periodSelector">Okres:</label>
    <select id="periodSelector" class="form-select d-inline-block w-auto mx-2" onchange="onPeriodChange()">
        <option value="day">Ostatnie 24h</option>
        <option value="week" selected>Ostatni tydzień</option>
        <option value="month">Ostatni miesiąc</option>
        <option value="all">Wszystkie</option>
    </select>
</div>

<!-- Paginacja góra -->
<div id="pagination-top" class="text-center my-3"></div>

<!-- Klipy -->
<div id="clips-container" class="row"></div>

<!-- Paginacja dół -->
<div id="pagination-bottom" class="text-center my-4"></div>

@section Scripts {
    <script>
        const gameName = "@Model.SelectedGame";
        const clipsPerPage = 10;
        let currentPage = 1;
        let period = document.getElementById("periodSelector")?.value || "week";

        function onPeriodChange() {
            period = document.getElementById("periodSelector").value;
            currentPage = 1;
            loadClips(currentPage);
        }

        async function loadClips(page) {
            const response = await fetch(`/api/clips?gameName=${encodeURIComponent(gameName)}&period=${period}&page=${page}&pageSize=${clipsPerPage}`);
            const data = await response.json();

            const container = document.getElementById("clips-container");
            container.innerHTML = "";

            data.clips.forEach(clip => {
                const col = document.createElement("div");
                col.className = "col-md-6 mb-4";
                col.innerHTML = `
                    <div class="card">
                        <div id="clip-${clip.id}" class="clip-container" style="cursor:pointer;" onclick="loadClip('${clip.id}', '${clip.embedUrl}')">
                            <img src="${clip.thumbnailUrl}" alt="${clip.title}" class="card-img-top clip-thumbnail" style="width:100%; height:auto;" />
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">${clip.title}</h5>
                            <p class="card-text">Autor: ${clip.broadcasterName}</p>
                        </div>
                    </div>`;
                container.appendChild(col);
            });

            renderPagination(page, data.hasMore);
        }

        function loadClip(clipId, embedUrl) {
            const container = document.getElementById(`clip-${clipId}`);
            container.innerHTML = `
                <iframe src="${embedUrl}&parent=${location.hostname}" height="360" width="100%" allowfullscreen></iframe>`;
        }

                     function renderPagination(current, hasMore) {
            const paginationTop = document.getElementById("pagination-top");
            const paginationBottom = document.getElementById("pagination-bottom");
            const totalVisible = 5;
            const totalPages = 10; // max 100 klipów / 10 na stronę

            [paginationTop, paginationBottom].forEach(pagination => {
                pagination.innerHTML = "";

                const createButton = (text, page, disabled = false, active = false) => {
                    const btn = document.createElement("button");
                    btn.className = "btn mx-1 " + (active ? "btn-primary" : "btn-outline-secondary");
                    btn.disabled = disabled;
                    btn.textContent = text;
                    if (!disabled) {
                        btn.onclick = () => loadClips(page);
                    }
                    return btn;
                };

                // Pierwsza i poprzednia
                pagination.appendChild(createButton("⏮️", 1, current === 1));
                pagination.appendChild(createButton("⟨", current - 1, current === 1));

                // Numery stron
                let start = Math.max(1, current - Math.floor(totalVisible / 2));
                let end = start + totalVisible - 1;

                // Jeśli koniec przekracza limit stron – przesuń w lewo
                if (end > totalPages) {
                    end = totalPages;
                    start = Math.max(1, end - totalVisible + 1);
                }

                for (let i = start; i <= end; i++) {
                    pagination.appendChild(createButton(i.toString(), i, false, i === current));
                }

                // Następna i ostatnia
                pagination.appendChild(createButton("⟩", current + 1, current >= totalPages));
                pagination.appendChild(createButton("⏭️", totalPages, current === totalPages));
            });
        }



        // Start
        loadClips(currentPage);
    </script>
}
